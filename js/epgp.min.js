/* EPGP - script to parse & display standings data from the epgp.lua created
 * by the World of Warcraft EPGP addon (http://code.google.com/p/epgp/)
 * http://github.com/Mottie/epgp
 *
 * Author: Rob G, aka Mottie (mottie.guildportal.com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * v1.0 8/25/2010 Original version, posted to github
 */

(function($){$.fn.epgp=function(v){var s=$.extend({},$.fn.epgp.defaults,v);return this.each(function(){var h=$(this),j=$.meta?$.extend({},s,h.data()):s,b,d,k,p,l,a,t=function(g){var c=[],m=[],e=[],f=[],i=g.log,n=g.snapshot.time-(h.find(".slider:first").data("value")||j.startEpgpHistory)*24*60*60;g=g.snapshot.time-(h.find(".slider:last").data("value")||j.startLootHistory)*24*60*60;for(b=0;b<i.length;b++){d=i[b][0];if(d>n||d>g){a=i[b][2];p=i[b][3];if(d>n){if(typeof c[a]=="undefined"){c[a]=0;m[a]=0}c[a]+=
i[b][1]=="EP"?i[b][4]:0;m[a]+=i[b][1]=="GP"?i[b][4]:0}if(d>g&&p.match("Hitem")){if(typeof e[a]=="undefined")e[a]='<div class="title">Loot History for '+a+'</div><table class="loot"><tr class="header"><th class="date">Time</th><th class="item">Item</th><th class="gp">GP</th></tr>';p=p.split("|");d=new Date(i[b][0]*1E3);k=d.toDateString().split(" ");f[a]='<a style="color:#'+p[1].slice(-6)+'" href="http://www.wowhead.com/item='+p[2].split(":")[1]+'">'+p[3].replace(/h\[|\]/g,"")+"</a>";e[a]+='<tr><td class="date">'+
k[2]+" "+k[1]+" "+d.toLocaleTimeString()+'</td><td class="item">'+f[a]+'</td><td class="gp">'+i[b][4]+"</td></tr>"}}}return[c,m,e,f]},w=function(){var g=h.data("data").namespaces.log.profiles[j.guild],c=g.snapshot.guild_info.replace(/\n/g,":").split(":"),m=parseInt(c[$.inArray("@BASE_GP",c)+1],10)||0,e=new Date(g.snapshot.time*1E3),f=e.getHours(),i=f>12?"PM":"AM";f=f>12?f-12:f;h.find(".date").html(e.toDateString()+" "+f+":"+e.getMinutes()+" "+i);h.find(".decay").html(c[$.inArray("@DECAY_P",c)+1]+
"%");h.find(".min").html(c[$.inArray("@MIN_EP",c)+1]);h.find(".base").html(m);h.find(".extras").html(j.extras);c=t(g);var n=g.snapshot.roster_info;d="";for(b=0;b<n.length;b++){k=n[b][2].split(",");if(k.length>1&&k[0]!="0"){a=n[b];k=a[2].split(",");e=parseInt(k[0],10);f=parseInt(k[1],10)+m;i=f===0?"":(e/f).toFixed(3);if(i===0)i="0";d+='<tr><td class="name '+a[1].toLowerCase()+'"><span class="data">'+a[0]+'</span></td><td class="ep"><span class="data">'+k[0]+'</span> <span class="diff ';e=c[0][a[0]]||
"";d+=e===0||e===""?"":e<0?"negative":"positive";d+='">'+e+'</span></td><td class="gp"><span class="data">'+f+'</span> <span class="diff ';f=c[1][a[0]]||"";d+=f===0||f===""?"":f<0?"negative":"positive";d+='">'+f+'</span></td><td class="pr"><span class="data">'+i+'</span></td><td class="lastitem">';d+=typeof c[2][a[0]]=="undefined"?"":'<img src="'+j.lootIcon+'" class="tooltip" title="'+c[2][a[0]].replace(/\"/g,"&quot;")+'</table>">';d+=typeof c[3][a[0]]=="undefined"?"":'<span class="data">'+c[3][a[0]]+
"</span>";d+="</td></tr>"}}if(d==="")h.html('<div align="center">No Data Found!</div>');else{h.find("tbody").append(d);h.find("table").tablesorter({textExtraction:function(o){return $(o).find("span.data").text()},sortList:[j.sort]});h.find(".slider").slider({min:1,max:30,step:1,slide:function(o,u){$(this).data("value",u.value);$(this).parent().find(".count").html(u.value);var q,r=t(g);h.find("tbody tr").each(function(){a=$(this).find(".name span").html();l=Math.round(r[0][a])||"";q=l===0||l===""?
"":l<0?"negative":"positive";$(this).find(".ep .diff").removeClass("negative positive").addClass(q).html(l);l=Math.round(r[1][a])||"";q=l===0||l===""?"":l<0?"negative":"positive";$(this).find(".gp .diff").removeClass("negative positive").addClass(q).html(l);$(this).find(".lastitem img").attr("title",r[2][a])})}});h.find(".sliders").find(".slider:first").slider("option","value",j.startEpgpHistory).data("value",j.startEpgpHistory).end().find(".count:first").html(j.startEpgpHistory).end().find(".slider:last").slider("option",
"value",j.startLootHistory).data("value",j.startLootHistory).end().find(".count:last").html(j.startLootHistory)}};$.ajax({url:j.epgpfile,success:function(g){g=g.replace(/\[(.*)\]\s\=\s/g,"$1:").replace(/[\t\r\n]/g,"").replace(/\}\,\s--\s\[\d+\]\}/g,"]]").replace(/\,\s--\s\[\d+\]/g,",").replace(/,(\}|\])/g,"$1").replace(/\}\,\{/g,"],[").replace(/\{\{/g,"[[").replace(/EPGP_DB\s\=/,"");g=$.parseJSON(g);h.data("data",g);if(j.lootOnly){var c,m;g=[];c=h.data("data").namespaces.log.profiles[j.guild];var e=
c.snapshot.roster_info,f=c.log,i=f.length-1,n=c.snapshot.time-(j.startLootHistory-1)*24*60*60-j.raidTime*60*60,o='<table class="loot"><tr class="header"><th class="date">Time</th><th class="member">Member</th><th class="item">Item</th><th class="gp">GP</th></tr>';d="";for(b=0;b<e.length;b++)g[e[b][0]]=e[b][1].toLowerCase();$.extend(g,j.fixClass);for(c=0;c<i;c++){b=i-c;d=f[b][0];e=f[b][3];if(d>n&&e.match("Hitem")){a=f[b][2];e=e.split("|");d=new Date(f[b][0]*1E3);k=d.toDateString().split(" ");m=typeof g[a]==
"undefined"?"unknown":g[a];o+='<tr><td class="date">'+k[2]+" "+k[1]+" "+d.toLocaleTimeString().replace(/:00\s/g," ")+'</td><td class="member '+m.toLowerCase()+'">'+a+'</td><td class="item"><a style="color:#'+e[1].slice(-6)+'" href="http://www.wowhead.com/item='+e[2].split(":")[1]+'">'+e[3].replace(/h\[|\]/g,"")+'</a></td><td class="gp">'+f[b][4]+"</td></tr>"}if(d<n)break}o=o.length<150?'<div align="center">No Data Found!</div>':o+"</table>";h.html(o)}else w()},error:function(){h.html('<div align="center">No Data Found!</div>')}})})};
$.fn.epgp.defaults={epgpfile:"epgp.lua",guild:"Fallout",startEpgpHistory:7,startLootHistory:7,extras:"100%",lootIcon:"images/plus.gif",sort:[3,1],lootOnly:false,raidTime:4,fixClass:[]}})(jQuery);
