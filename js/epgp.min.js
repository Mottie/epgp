/* EPGP - script to parse & display standings data from the epgp.lua created
 * by the World of Warcraft EPGP addon (http://code.google.com/p/epgp/)
 * http://github.com/Mottie/epgp
 *
 * Author: Rob G, aka Mottie (mottie.guildportal.com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * v1.0 8/25/2010 Original version, posted to github
 */

(function($){$.fn.epgp=function(v){var s=$.extend({},$.fn.epgp.defaults,v);return this.each(function(){var h=$(this),j=$.meta?$.extend({},s,h.data()):s,b,c,k,p,l,a,t=function(g){var f=[],m=[],d=[],e=[],i=g.log,n=g.snapshot.time-(h.find(".slider:first").data("value")||j.startEpgpHistory)*24*60*60;g=g.snapshot.time-(h.find(".slider:last").data("value")||j.startLootHistory)*24*60*60;for(b=0;b<i.length;b++){c=i[b][0];if(c>n||c>g){a=i[b][2];p=i[b][3];if(c>n){if(typeof f[a]=="undefined"){f[a]=0;m[a]=0}f[a]+=
i[b][1]=="EP"?i[b][4]:0;m[a]+=i[b][1]=="GP"?i[b][4]:0}if(c>g&&p.match("Hitem")){if(typeof d[a]=="undefined")d[a]='<div class="title">Loot History for '+a+'</div><table class="loot"><tr class="header"><th class="date">Time</th><th class="item">Item</th><th class="gp">GP</th></tr>';p=p.split("|");c=new Date(i[b][0]*1E3);k=c.toDateString().split(" ");e[a]='<a style="color:#'+p[1].slice(-6)+'" href="http://www.wowhead.com/item='+p[2].split(":")[1]+'">'+p[3].replace(/h\[|\]/g,"")+"</a>";d[a]+='<tr><td class="date">'+
k[2]+" "+k[1]+" "+c.toLocaleTimeString()+'</td><td class="item">'+e[a]+'</td><td class="gp">'+i[b][4]+"</td></tr>"}}}return[f,m,d,e]},w=function(){var g=h.data("data").namespaces.log.profiles[j.guild],f=g.snapshot.guild_info.split("\n"),m=parseInt(f[0].split(":")[1],10),d=new Date(g.snapshot.time*1E3),e=d.getHours(),i=e>12?"PM":"AM";e=e>12?e-12:e;h.find(".date").html(d.toDateString()+" "+e+":"+d.getMinutes()+" "+i);h.find(".decay").html(f[2].split(":")[1]+"%");h.find(".min").html(f[1].split(":")[1]);
h.find(".base").html(m);h.find(".extras").html(j.extras);f=t(g);var n=g.snapshot.roster_info;c="";for(b=0;b<n.length;b++){k=n[b][2].split(",");if(k.length>1&&k[0]!="0"){a=n[b];k=a[2].split(",");d=parseInt(k[0],10);e=parseInt(k[1],10)+m;i=e===0?"":(d/e).toFixed(3);if(i===0)i="0";c+='<tr><td class="name '+a[1].toLowerCase()+'"><span class="data">'+a[0]+'</span></td><td class="ep"><span class="data">'+k[0]+'</span> <span class="diff ';d=f[0][a[0]]||"";c+=d===0||d===""?"":d<0?"negative":"positive";c+=
'">'+d+'</span></td><td class="gp"><span class="data">'+e+'</span> <span class="diff ';e=f[1][a[0]]||"";c+=e===0||e===""?"":e<0?"negative":"positive";c+='">'+e+'</span></td><td class="pr"><span class="data">'+i+'</span></td><td class="lastitem">';c+=typeof f[2][a[0]]=="undefined"?"":'<img src="'+j.lootIcon+'" class="tooltip" title="'+f[2][a[0]].replace(/\"/g,"&quot;")+'</table>">';c+=typeof f[3][a[0]]=="undefined"?"":'<span class="data">'+f[3][a[0]]+"</span>";c+="</td></tr>"}}if(c==="")h.html('<div align="center">No Data Found!</div>');
else{h.find("tbody").append(c);h.find("table").tablesorter({textExtraction:function(o){return $(o).find("span.data").text()},sortList:[j.sort]});h.find(".slider").slider({min:1,max:30,step:1,slide:function(o,u){$(this).data("value",u.value);$(this).parent().find(".count").html(u.value);var q,r=t(g);h.find("tbody tr").each(function(){a=$(this).find(".name span").html();l=Math.round(r[0][a])||"";q=l===0||l===""?"":l<0?"negative":"positive";$(this).find(".ep .diff").removeClass("negative positive").addClass(q).html(l);
l=Math.round(r[1][a])||"";q=l===0||l===""?"":l<0?"negative":"positive";$(this).find(".gp .diff").removeClass("negative positive").addClass(q).html(l);$(this).find(".lastitem img").attr("title",r[2][a])})}});h.find(".sliders").find(".slider:first").slider("option","value",j.startEpgpHistory).data("value",j.startEpgpHistory).end().find(".count:first").html(j.startEpgpHistory).end().find(".slider:last").slider("option","value",j.startLootHistory).data("value",j.startLootHistory).end().find(".count:last").html(j.startLootHistory)}};
$.ajax({url:j.epgpfile,success:function(g){g=g.replace(/\[(.*)\]\s\=\s/g,"$1:").replace(/[\t\r\n]/g,"").replace(/\}\,\s--\s\[\d+\]\}/g,"]]").replace(/\,\s--\s\[\d+\]/g,",").replace(/,(\}|\])/g,"$1").replace(/\}\,\{/g,"],[").replace(/\{\{/g,"[[").replace(/EPGP_DB\s\=/,"");g=$.parseJSON(g);h.data("data",g);if(j.lootOnly){var f,m;g=[];f=h.data("data").namespaces.log.profiles[j.guild];var d=f.snapshot.roster_info,e=f.log,i=e.length-1,n=f.snapshot.time-(j.startLootHistory-1)*24*60*60-j.raidTime*60*60,
o='<table class="loot"><tr class="header"><th class="date">Time</th><th class="member">Member</th><th class="item">Item</th><th class="gp">GP</th></tr>';c="";for(b=0;b<d.length;b++)g[d[b][0]]=d[b][1].toLowerCase();$.extend(g,j.fixClass);for(f=0;f<i;f++){b=i-f;c=e[b][0];d=e[b][3];if(c>n&&d.match("Hitem")){a=e[b][2];d=d.split("|");c=new Date(e[b][0]*1E3);k=c.toDateString().split(" ");m=typeof g[a]=="undefined"?"unknown":g[a];o+='<tr><td class="date">'+k[2]+" "+k[1]+" "+c.toLocaleTimeString().replace(/:00\s/g,
" ")+'</td><td class="member '+m+'">'+a+'</td><td class="item"><a style="color:#'+d[1].slice(-6)+'" href="http://www.wowhead.com/item='+d[2].split(":")[1]+'">'+d[3].replace(/h\[|\]/g,"")+'</a></td><td class="gp">'+e[b][4]+"</td></tr>"}if(c<n)break}o=o.length<150?'<div align="center">No Data Found!</div>':o+"</table>";h.html(o)}else w()},error:function(){h.html('<div align="center">No Data Found!</div>')}})})};$.fn.epgp.defaults={epgpfile:"epgp.lua",guild:"Fallout",startEpgpHistory:7,startLootHistory:7,
extras:"100%",lootIcon:"images/plus.gif",sort:[3,1],lootOnly:false,raidTime:4,fixClass:[]}})(jQuery);
