/* EPGP - script to parse & display standings data from the epgp.lua created
 * by the World of Warcraft EPGP addon (http://code.google.com/p/epgp/)
 * http://github.com/Mottie/epgp
 *
 * Author: Rob G, aka Mottie (mottie.guildportal.com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * v1.0 8/25/2010 Original version, posted to github
 */

(function($){$.fn.epgp=function(v){var s=$.extend({},$.fn.epgp.defaults,v);return this.each(function(){var h=$(this),i=$.meta?$.extend({},s,h.data()):s,c,a,k,p,l,b,t=function(g){var d=[],m=[],e=[],f=[],j=g.log,n=g.snapshot.time-(h.find(".slider:first").data("value")||i.startEpgpHistory)*24*60*60;g=g.snapshot.time-(h.find(".slider:last").data("value")||i.startLootHistory)*24*60*60;for(c=0;c<j.length;c++){a=j[c][0];if(a>n||a>g){b=j[c][2];p=j[c][3];if(a>n){if(typeof d[b]=="undefined"){d[b]=0;m[b]=0}d[b]+=
j[c][1]=="EP"?j[c][4]:0;m[b]+=j[c][1]=="GP"?j[c][4]:0}if(a>g&&p.match("Hitem")){if(typeof e[b]=="undefined")e[b]='<div class="title">Loot History for '+b+'</div><table class="loot"><tr class="header"><th class="date">Time</th><th class="item">Item</th><th class="gp">GP</th></tr>';p=p.split("|");a=new Date(j[c][0]*1E3);k=a.toDateString().split(" ");f[b]='<a style="color:#'+p[1].slice(-6)+'" href="http://www.wowhead.com/item='+p[2].split(":")[1]+'">'+p[3].replace(/h\[|\]/g,"")+"</a>";e[b]+='<tr><td class="date">'+
k[2]+" "+k[1]+" "+a.toLocaleTimeString()+'</td><td class="item">'+f[b]+'</td><td class="gp">'+j[c][4]+"</td></tr>"}}}return[d,m,e,f]},w=function(){var g=h.data("data").namespaces.log.profiles[i.guild],d=g.snapshot.guild_info.replace(/\n/g,":").split(":"),m=parseInt(d[$.inArray("@BASE_GP",d)+1],10)||0,e=new Date(g.snapshot.time*1E3),f=e.getHours(),j=f>12?"PM":"AM";f=f>12?f-12:f;a='<div class="header">Date: <span class="date"></span><br><br>Decay: <span class="decay"> </span> BaseGP: <span class="base"> </span> MinEP: <span class="min"> </span> Extras: <span class="extras"> </span></div><br><table class="epgp"><thead><tr class="title"><th class="name class">Name</th><th class="ep">EP</th><th class="gp">GP</th><th class="pr">PR</th><th class="lastitem">Last Item</th></tr></thead><tbody></tbody></table>';
h.html(a);if(i.addSliders){a='<div class="sliders"><div>EPGP ( <span class="count"></span> days from snapshot )<br><div class="slider"></div></div><br><div>Loot ( <span class="count"></span> days from snapshot )<br><div class="slider"></div></div></div>';h.find(".header").prepend(a)}h.find(".date").html(e.toDateString()+" "+f+":"+e.getMinutes()+" "+j);h.find(".decay").html(d[$.inArray("@DECAY_P",d)+1]+"%");h.find(".min").html(d[$.inArray("@MIN_EP",d)+1]);h.find(".base").html(m);h.find(".extras").html(i.extras);
d=t(g);var n=g.snapshot.roster_info;a="";for(c=0;c<n.length;c++){k=n[c][2].split(",");if(k.length>1&&k[0]!="0"){b=n[c];k=b[2].split(",");e=parseInt(k[0],10);f=parseInt(k[1],10)+m;j=f===0?"":(e/f).toFixed(3);if(j===0)j="0";a+='<tr><td class="name '+b[1].toLowerCase()+'"><span class="data">'+b[0]+'</span></td><td class="ep"><span class="data">'+k[0]+'</span> <span class="diff ';e=d[0][b[0]]||"";a+=e===0||e===""?"":e<0?"negative":"positive";a+='">'+e+'</span></td><td class="gp"><span class="data">'+
f+'</span> <span class="diff ';f=d[1][b[0]]||"";a+=f===0||f===""?"":f<0?"negative":"positive";a+='">'+f+'</span></td><td class="pr"><span class="data">'+j+'</span></td><td class="lastitem">';a+=typeof d[2][b[0]]=="undefined"?"":'<img src="'+i.lootIcon+'" class="tooltip" title="'+d[2][b[0]].replace(/\"/g,"&quot;")+'</table>">';a+=typeof d[3][b[0]]=="undefined"?"":'<span class="data">'+d[3][b[0]]+"</span>";a+="</td></tr>"}}if(a==="")h.html('<div align="center">No Data Found!</div>');else{h.find("tbody").append(a);
h.find("table").tablesorter({textExtraction:function(o){return $(o).find("span.data").text()},sortList:[i.sort]});if(i.addSliders){h.find(".slider").slider({min:1,max:i.maxHistory,step:1,slide:function(o,u){$(this).data("value",u.value);$(this).parent().find(".count").html(u.value);var q,r=t(g);h.find("tbody tr").each(function(){b=$(this).find(".name span").html();l=Math.round(r[0][b])||"";q=l===0||l===""?"":l<0?"negative":"positive";$(this).find(".ep .diff").removeClass("negative positive").addClass(q).html(l);
l=Math.round(r[1][b])||"";q=l===0||l===""?"":l<0?"negative":"positive";$(this).find(".gp .diff").removeClass("negative positive").addClass(q).html(l);$(this).find(".lastitem img").attr("title",r[2][b])})}});h.find(".sliders").find(".slider:first").slider("option","value",i.startEpgpHistory).data("value",i.startEpgpHistory).end().find(".count:first").html(i.startEpgpHistory).end().find(".slider:last").slider("option","value",i.startLootHistory).data("value",i.startLootHistory).end().find(".count:last").html(i.startLootHistory)}}};
$.ajax({url:i.epgpfile,success:function(g){g=g.replace(/\[(.*)\]\s\=\s/g,"$1:").replace(/[\t\r\n]/g,"").replace(/\}\,\s--\s\[\d+\]\}/g,"]]").replace(/\,\s--\s\[\d+\]/g,",").replace(/,(\}|\])/g,"$1").replace(/\}\,\{/g,"],[").replace(/\{\{/g,"[[").replace(/EPGP_DB\s\=/,"");g=$.parseJSON(g);h.data("data",g);if(i.lootOnly){var d,m;g=[];d=h.data("data").namespaces.log.profiles[i.guild];var e=d.snapshot.roster_info,f=d.log,j=f.length-1,n=d.snapshot.time-(i.startLootHistory-1)*24*60*60-i.raidTime*60*60,
o='<table class="loot"><tr class="header"><th class="date">Time</th><th class="member">Member</th><th class="item">Item</th><th class="gp">GP</th></tr>';a="";for(c=0;c<e.length;c++)g[e[c][0]]=e[c][1].toLowerCase();$.extend(g,i.fixClass);for(d=0;d<j;d++){c=j-d;a=f[c][0];e=f[c][3];if(a>n&&e.match("Hitem")){b=f[c][2];e=e.split("|");a=new Date(f[c][0]*1E3);k=a.toDateString().split(" ");m=typeof g[b]=="undefined"?"unknown":g[b];o+='<tr><td class="date">'+k[2]+" "+k[1]+" "+a.toLocaleTimeString().replace(/:00\s/g,
" ")+'</td><td class="member '+m.toLowerCase()+'">'+b+'</td><td class="item"><a style="color:#'+e[1].slice(-6)+'" href="http://www.wowhead.com/item='+e[2].split(":")[1]+'">'+e[3].replace(/h\[|\]/g,"")+'</a></td><td class="gp">'+f[c][4]+"</td></tr>"}if(a<n)break}o=o.length<150?'<div align="center">No Data Found!</div>':o+"</table>";h.html(o)}else w()},error:function(){h.html('<div align="center">No Data Found!</div>')}})})};$.fn.epgp.defaults={epgpfile:"epgp.lua",guild:"Fallout",startEpgpHistory:7,
startLootHistory:7,addSliders:true,maxHistory:30,extras:"100%",lootIcon:"images/plus.gif",sort:[3,1],lootOnly:false,raidTime:4,fixClass:[]}})(jQuery);
